<!DOCTYPE html>
<html lang="en" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Universal AI - Multimodal</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gemini: {
                            50: '#f0f4f9', 100: '#e1e5ea', 800: '#1e1f20', 900: '#131314', accent: '#4b90ff'
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        .markdown-body p { margin-bottom: 0.75em; line-height: 1.6; }
        .markdown-body pre { background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin-bottom: 1rem; }
        .markdown-body code { font-family: monospace; background: rgba(0,0,0,0.1); padding: 0.2em 0.4em; border-radius: 3px; font-size: 0.9em; }
        .dark .markdown-body code { background: rgba(255,255,255,0.1); }
        
        /* Generated Media Styles */
        .ai-media-container { margin-top: 10px; margin-bottom: 10px; border-radius: 12px; overflow: hidden; position: relative; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .ai-image { width: 100%; height: auto; display: block; transition: transform 0.3s ease; cursor: pointer; }
        .ai-image:hover { transform: scale(1.02); }
        .media-badge { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; backdrop-filter: blur(4px); }

        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; z-index: 9999; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s ease; }
        .dark #loading { background: #131314; color: white; }
    </style>
</head>
<body class="bg-gemini-50 text-gray-800 dark:bg-gemini-900 dark:text-gray-100 transition-colors duration-200 h-[100dvh] w-full overflow-hidden flex flex-col">

    <div id="loading">
        <div class="flex flex-col items-center gap-4">
            <i class="fa-solid fa-wand-magic-sparkles fa-spin text-4xl text-blue-500"></i>
            <span class="text-lg font-medium">Loading AI Studio...</span>
        </div>
    </div>

    <div id="app" class="flex flex-1 overflow-hidden relative opacity-0 transition-opacity duration-500">
        
        <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-20 hidden md:hidden" onclick="toggleSidebar()"></div>
        <aside id="sidebar" class="absolute md:relative z-30 w-72 h-full bg-gray-100 dark:bg-gemini-800 transform -translate-x-full md:translate-x-0 transition-transform duration-300 flex flex-col border-r border-gray-200 dark:border-gray-700 shadow-xl md:shadow-none">
            <div class="p-4">
                <button onclick="createNewChat()" class="w-full flex items-center gap-3 px-4 py-3 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-xl transition-colors text-sm font-medium">
                    <i class="fa-solid fa-plus text-gray-500 dark:text-gray-300"></i>
                    <span>New Chat</span>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto px-2" id="chatHistoryList"></div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                <button onclick="toggleSettings()" class="flex items-center gap-3 px-2 py-2 w-full hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg text-sm transition-colors">
                    <i class="fa-solid fa-gear"></i> <span>Settings</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full relative min-w-0">
            <header class="h-14 flex items-center justify-between px-4 border-b border-gray-200 dark:border-gray-700 md:hidden bg-white dark:bg-gemini-900 z-10">
                <button onclick="toggleSidebar()" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">
                    <i class="fa-solid fa-bars text-lg"></i>
                </button>
                <span class="font-semibold text-sm">Universal AI</span>
                <div class="w-8"></div>
            </header>

            <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth">
                <div id="welcomeState" class="h-full flex flex-col items-center justify-center opacity-60 text-center px-4">
                    <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/50 rounded-full flex items-center justify-center mb-4">
                        <i class="fa-solid fa-infinity text-3xl text-blue-500"></i>
                    </div>
                    <h1 class="text-2xl font-bold mb-2">Text. Images. Video.</h1>
                    <p class="text-sm max-w-md">I can generate unlimited images and videos for free. Just ask "Generate an image of..." or "Make a video of..."</p>
                </div>
            </div>

            <div class="p-4 bg-white dark:bg-gemini-900/90 backdrop-blur-sm border-t border-gray-200 dark:border-gray-700 z-20">
                <div class="max-w-4xl mx-auto relative">
                    <textarea 
                        id="promptInput" rows="1" 
                        class="w-full bg-gray-100 dark:bg-gemini-800 rounded-3xl pl-5 pr-12 py-3.5 focus:outline-none focus:ring-2 focus:ring-blue-500/50 resize-none overflow-hidden max-h-32 shadow-sm text-base"
                        placeholder="Ask me to generate an image..."
                        oninput="autoResize(this)"
                        onkeydown="handleEnter(event)"
                    ></textarea>
                    <button id="sendBtn" onclick="sendMessage()" class="absolute right-2 bottom-2 p-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full w-10 h-10 flex items-center justify-center transition-all disabled:opacity-50">
                        <i class="fa-solid fa-arrow-up text-sm"></i>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <div id="settingsModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-gemini-800 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-95 opacity-0" id="settingsContent">
            <div class="p-5 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h2 class="text-lg font-bold">Settings</h2>
                <button onclick="toggleSettings()" class="text-gray-500 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-semibold uppercase text-gray-500 mb-1">OpenRouter API Key</label>
                    <input type="password" id="apiKeyInput" class="w-full bg-gray-100 dark:bg-gray-700 rounded-lg px-3 py-2 border border-transparent focus:border-blue-500 focus:outline-none text-sm" placeholder="sk-or-...">
                </div>
                <div>
                    <label class="block text-xs font-semibold uppercase text-gray-500 mb-1">Model Name</label>
                    <input type="text" id="modelInput" class="w-full bg-gray-100 dark:bg-gray-700 rounded-lg px-3 py-2 border border-transparent focus:border-blue-500 focus:outline-none text-sm" placeholder="deepseek/deepseek-r1:free">
                </div>
                <div class="flex items-center justify-between pt-2">
                    <span class="text-sm font-medium">Dark Mode</span>
                    <button onclick="toggleTheme()" class="w-12 h-6 bg-gray-300 dark:bg-blue-600 rounded-full relative transition-colors">
                        <div id="themeDot" class="w-4 h-4 bg-white rounded-full absolute top-1 left-1 transition-all shadow-md"></div>
                    </button>
                </div>
            </div>
            <div class="p-4 bg-gray-50 dark:bg-gray-700/30 flex justify-end">
                <button onclick="saveSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg text-sm font-medium transition-colors">Save</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONSTANTS & STATE
        // ==========================================
        const DEFAULT_MODEL = "deepseek/deepseek-r1:free";
        // The magic prompt that teaches the LLM how to use the 'tools'
        const SYSTEM_PROMPT = `You are an advanced multimodal AI assistant. 
        You can generate unlimited images and videos.
        
        IMPORTANT RULES FOR GENERATION:
        1. If the user asks to "generate", "draw", or "create" an IMAGE, you MUST output the prompt exactly like this:
           {{image: detailed description of the image}}
           
        2. If the user asks for a VIDEO, output exactly like this:
           {{video: detailed description of the movement or scene}}
           
        3. Do NOT display the image markdown syntax directly. Use the {{tag}} format.
        4. Do NOT say "I cannot generate images". You CAN, using these tags.
        `;

        const state = {
            chats: JSON.parse(localStorage.getItem('chats_v2')) || [],
            activeChatId: null,
            settings: {
                apiKey: localStorage.getItem('apiKey') || '',
                model: localStorage.getItem('model') || DEFAULT_MODEL,
                darkMode: localStorage.getItem('darkMode') === 'true'
            },
            isGenerating: false
        };

        const els = {
            app: document.getElementById('app'),
            loading: document.getElementById('loading'),
            messages: document.getElementById('messagesContainer'),
            welcome: document.getElementById('welcomeState'),
            input: document.getElementById('promptInput'),
            sendBtn: document.getElementById('sendBtn'),
            sidebar: document.getElementById('sidebar'),
            sidebarOverlay: document.getElementById('sidebarOverlay'),
            chatList: document.getElementById('chatHistoryList'),
            settingsModal: document.getElementById('settingsModal'),
            settingsContent: document.getElementById('settingsContent'),
            apiKey: document.getElementById('apiKeyInput'),
            model: document.getElementById('modelInput'),
            themeDot: document.getElementById('themeDot')
        };

        // ==========================================
        // INIT & UI
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            if (state.settings.darkMode) document.documentElement.classList.add('dark');
            updateThemeUI();

            if (state.chats.length > 0) {
                const lastId = localStorage.getItem('lastActiveChatId');
                const exists = state.chats.find(c => c.id === lastId);
                loadChat(exists ? lastId : state.chats[0].id);
            } else {
                renderChatList();
            }

            setTimeout(() => {
                els.loading.style.opacity = '0';
                setTimeout(() => {
                    els.loading.style.display = 'none';
                    els.app.style.opacity = '1';
                }, 500);
            }, 500);
        });

        function autoResize(t) {
            t.style.height = 'auto';
            t.style.height = t.scrollHeight + 'px';
            if (t.value === '') t.style.height = '56px';
        }

        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function toggleSidebar() {
            const isClosed = els.sidebar.classList.contains('-translate-x-full');
            els.sidebar.classList.toggle('-translate-x-full', !isClosed);
            els.sidebarOverlay.classList.toggle('hidden', !isClosed);
        }

        function toggleTheme() {
            state.settings.darkMode = !state.settings.darkMode;
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('darkMode', state.settings.darkMode);
            updateThemeUI();
        }

        function updateThemeUI() {
            if (state.settings.darkMode) {
                els.themeDot.style.left = '1.75rem'; // 7 * 0.25rem
            } else {
                els.themeDot.style.left = '0.25rem';
            }
        }

        function toggleSettings() {
            const modal = els.settingsModal;
            const content = els.settingsContent;
            if (modal.classList.contains('hidden')) {
                els.apiKey.value = state.settings.apiKey;
                els.model.value = state.settings.model;
                modal.classList.remove('hidden');
                setTimeout(() => {
                    content.classList.remove('scale-95', 'opacity-0');
                    content.classList.add('scale-100', 'opacity-100');
                }, 10);
            } else {
                content.classList.remove('scale-100', 'opacity-100');
                content.classList.add('scale-95', 'opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 200);
            }
        }

        function saveSettings() {
            state.settings.apiKey = els.apiKey.value.trim();
            state.settings.model = els.model.value.trim() || DEFAULT_MODEL;
            localStorage.setItem('apiKey', state.settings.apiKey);
            localStorage.setItem('model', state.settings.model);
            toggleSettings();
        }

        // ==========================================
        // CORE CHAT LOGIC
        // ==========================================
        function createNewChat() {
            const newChat = { id: Date.now().toString(), title: "New Conversation", messages: [] };
            state.chats.unshift(newChat);
            saveChats();
            loadChat(newChat.id);
            if (window.innerWidth < 768) toggleSidebar();
        }

        function loadChat(id) {
            state.activeChatId = id;
            localStorage.setItem('lastActiveChatId', id);
            renderChatList();
            renderMessages(state.chats.find(c => c.id === id)?.messages || []);
        }

        function saveChats() {
            localStorage.setItem('chats_v2', JSON.stringify(state.chats));
        }

        function deleteChat(e, id) {
            e.stopPropagation();
            if(!confirm("Delete chat?")) return;
            state.chats = state.chats.filter(c => c.id !== id);
            saveChats();
            if(state.activeChatId === id) {
                state.activeChatId = null;
                state.chats.length ? loadChat(state.chats[0].id) : (renderChatList(), renderMessages([]));
            } else {
                renderChatList();
            }
        }

        function renderChatList() {
            els.chatList.innerHTML = '';
            if (state.chats.length === 0) {
                els.chatList.innerHTML = `<div class="text-center text-gray-400 mt-10 text-xs">No chats yet</div>`;
                return;
            }
            state.chats.forEach(chat => {
                const isActive = chat.id === state.activeChatId;
                const div = document.createElement('div');
                div.className = `group flex items-center justify-between p-2 rounded-lg cursor-pointer mb-1 text-sm ${isActive ? 'bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300' : 'hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300'}`;
                div.onclick = () => loadChat(chat.id);
                div.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <i class="fa-regular fa-message ${isActive ? 'text-blue-500' : 'text-gray-400'}"></i>
                        <span class="truncate max-w-[140px]">${chat.title}</span>
                    </div>
                    <button onclick="deleteChat(event, '${chat.id}')" class="opacity-0 group-hover:opacity-100 hover:text-red-500 transition-opacity"><i class="fa-solid fa-trash"></i></button>
                `;
                els.chatList.appendChild(div);
            });
        }

        // ==========================================
        // RENDERING & PARSING (THE MAGIC)
        // ==========================================
        function renderMessages(messages) {
            els.messages.innerHTML = '';
            if (messages.length === 0) {
                els.welcome.style.display = 'flex';
            } else {
                els.welcome.style.display = 'none';
                messages.forEach(msg => appendMessageToDOM(msg));
                scrollToBottom();
            }
        }

        // Parse content to inject Images/Videos
        function parseContent(content) {
            // Regex for Image Tag: {{image: prompt}}
            let parsed = content.replace(/{{image:\s*(.*?)}}/g, (match, prompt) => {
                const seed = Math.floor(Math.random() * 100000);
                const safePrompt = encodeURIComponent(prompt.trim());
                // Pollinations URL
                const url = `https://image.pollinations.ai/prompt/${safePrompt}?nologo=true&seed=${seed}&width=1024&height=768`;
                return `
                <div class="ai-media-container">
                    <img src="${url}" class="ai-image" alt="${prompt}" loading="lazy" onclick="window.open(this.src, '_blank')">
                    <div class="media-badge"><i class="fa-solid fa-image"></i> AI Generated</div>
                </div>`;
            });

            // Regex for Video Tag: {{video: prompt}}
            // Note: Pollinations video often redirects to a waiting page or returns a GIF, we use the image endpoint with model=turbo for fast generation as frames or their video endpoint if available.
            // For stability in zero-build, we treat video as a high-fidelity rendering or specific video endpoint link.
            parsed = parsed.replace(/{{video:\s*(.*?)}}/g, (match, prompt) => {
                 const seed = Math.floor(Math.random() * 100000);
                 const safePrompt = encodeURIComponent(prompt.trim());
                 // Using Pollinations video endpoint (often requires opening in new tab or specific embed handling)
                 // A safer embedded zero-build approach for "Unlimited Video" is prompting their gif generator or linking out.
                 // We will generate a link card.
                 return `
                 <div class="ai-media-container bg-black rounded-xl p-4 text-center">
                    <div class="text-white mb-2"><i class="fa-solid fa-film text-2xl"></i></div>
                    <p class="text-gray-300 text-sm mb-3">Video generation for: "${prompt.trim()}"</p>
                    <a href="https://pollinations.ai/p/${safePrompt}?width=720&height=1280&mo
