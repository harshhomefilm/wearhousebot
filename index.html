<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Universal AI Chat - Gemini Clone</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Marked.js for Markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* Custom scrollbar for chat */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.2); border-radius:3px; }
    ::-webkit-scrollbar-track { background: transparent; }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex">

  <!-- Loading fallback -->
  <div id="loading" class="fixed inset-0 flex items-center justify-center bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 z-50">
    Loading App...
  </div>

  <!-- Sidebar -->
  <div id="sidebar" class="bg-white dark:bg-gray-800 w-64 min-h-screen border-r border-gray-200 dark:border-gray-700 flex flex-col transform -translate-x-64 md:translate-x-0 transition-transform duration-300">
    <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
      <h1 class="font-bold text-lg">Chats</h1>
      <button id="newChatBtn" class="bg-blue-500 text-white px-2 py-1 rounded">New Chat</button>
    </div>
    <div id="chatList" class="flex-1 overflow-y-auto"></div>
    <div class="p-4 border-t border-gray-200 dark:border-gray-700">
      <button id="settingsBtn" class="w-full bg-gray-300 dark:bg-gray-700 text-gray-900 dark:text-gray-100 px-2 py-1 rounded">Settings âš™ï¸</button>
      <button id="darkModeToggle" class="w-full mt-2 bg-gray-300 dark:bg-gray-700 text-gray-900 dark:text-gray-100 px-2 py-1 rounded">Toggle Dark Mode ğŸŒ™</button>
    </div>
  </div>

  <!-- Main Chat Area -->
  <div class="flex-1 flex flex-col min-h-screen">
    <div class="md:hidden p-2 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-white dark:bg-gray-800">
      <button id="mobileMenuBtn" class="text-gray-900 dark:text-gray-100">â˜°</button>
      <span class="font-bold">Universal AI Chat</span>
      <div></div>
    </div>
    <div id="chatArea" class="flex-1 p-4 overflow-y-auto space-y-4"></div>

    <!-- Input Bar -->
    <div class="sticky bottom-0 bg-white dark:bg-gray-800 p-2 border-t border-gray-200 dark:border-gray-700 flex items-center">
      <input id="messageInput" type="text" placeholder="Type your message..." class="flex-1 px-4 py-2 rounded border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" />
      <button id="sendBtn" class="ml-2 bg-blue-500 text-white px-4 py-2 rounded">Send</button>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 p-6 rounded w-80">
      <h2 class="text-lg font-bold mb-4">Settings</h2>
      <div class="mb-3">
        <label class="block mb-1">OpenRouter API Key</label>
        <input id="apiKeyInput" type="password" placeholder="API Key" class="w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700"/>
      </div>
      <div class="mb-3">
        <label class="block mb-1">Model</label>
        <input id="modelInput" type="text" placeholder="Model" value="deepseek/deepseek-r1:free" class="w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700"/>
      </div>
      <div class="flex justify-end space-x-2">
        <button id="closeSettings" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 rounded">Close</button>
        <button id="saveSettings" class="px-4 py-2 bg-blue-500 text-white rounded">Save</button>
      </div>
    </div>
  </div>

  <script>
    (() => {
      const loading = document.getElementById('loading');
      const sidebar = document.getElementById('sidebar');
      const chatListEl = document.getElementById('chatList');
      const chatArea = document.getElementById('chatArea');
      const messageInput = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');
      const settingsBtn = document.getElementById('settingsBtn');
      const settingsModal = document.getElementById('settingsModal');
      const closeSettings = document.getElementById('closeSettings');
      const saveSettings = document.getElementById('saveSettings');
      const apiKeyInput = document.getElementById('apiKeyInput');
      const modelInput = document.getElementById('modelInput');
      const darkModeToggle = document.getElementById('darkModeToggle');
      const newChatBtn = document.getElementById('newChatBtn');
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');

      let state = {
        chats: [],
        activeChat: null,
        apiKey: '',
        model: 'deepseek/deepseek-r1:free',
        darkMode: false,
        systemPrompt: ''
      };

      // Load from localStorage
      const loadState = () => {
        try {
          const savedChats = JSON.parse(localStorage.getItem('chats') || '[]');
          const apiKey = localStorage.getItem('apiKey') || '';
          const model = localStorage.getItem('model') || 'deepseek/deepseek-r1:free';
          const darkMode = localStorage.getItem('darkMode') === 'true';
          const systemPrompt = localStorage.getItem('systemPrompt') || '';
          state = { ...state, chats: savedChats, apiKey, model, darkMode, systemPrompt };
        } catch(e) { console.error(e); }
      };

      const saveState = () => {
        localStorage.setItem('chats', JSON.stringify(state.chats));
        localStorage.setItem('apiKey', state.apiKey);
        localStorage.setItem('model', state.model);
        localStorage.setItem('darkMode', state.darkMode);
        localStorage.setItem('systemPrompt', state.systemPrompt);
      };

      const toggleDarkMode = () => {
        state.darkMode = !state.darkMode;
        document.body.classList.toggle('dark', state.darkMode);
        saveState();
      };

      const renderChats = () => {
        chatListEl.innerHTML = '';
        state.chats.forEach((chat, idx) => {
          const div = document.createElement('div');
          div.className = 'p-2 cursor-pointer border-b border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700 flex justify-between items-center';
          div.innerHTML = `
            <span>${chat.name || 'Untitled Chat'}</span>
            <div class="space-x-1">
              <button data-action="rename" data-idx="${idx}" class="text-xs text-blue-500">âœï¸</button>
              <button data-action="delete" data-idx="${idx}" class="text-xs text-red-500">ğŸ—‘ï¸</button>
            </div>
          `;
          div.addEventListener('click', (e) => {
            if(e.target.dataset.action) return;
            state.activeChat = idx;
            renderMessages();
          });
          chatListEl.appendChild(div);
        });
      };

      const renderMessages = () => {
        chatArea.innerHTML = '';
        if(state.activeChat === null) return;
        const messages = state.chats[state.activeChat].messages;
        messages.forEach(msg => {
          const div = document.createElement('div');
          div.className = `max-w-[80%] p-2 rounded ${msg.role==='user'?'bg-blue-100 text-right ml-auto':'bg-gray-200 dark:bg-gray-700 text-left mr-auto'} break-words`;
          div.innerHTML = marked.parse(msg.content);
          chatArea.appendChild(div);
        });
        chatArea.scrollTop = chatArea.scrollHeight;
      };

      const addMessage = (role, content) => {
        if(state.activeChat === null) {
          newChat();
        }
        state.chats[state.activeChat].messages.push({ role, content });
        renderMessages();
        saveState();
      };

      const newChat = () => {
        const chat = { name: `Chat ${state.chats.length+1}`, messages: [] };
        state.chats.push(chat);
        state.activeChat = state.chats.length - 1;
        renderChats();
        renderMessages();
        saveState();
      };

      const renameChat = (idx) => {
        const name = prompt('New chat name', state.chats[idx].name);
        if(name) state.chats[idx].name = name;
        renderChats();
        saveState();
      };

      const deleteChat = (idx) => {
        if(!confirm('Delete this chat?')) return;
        state.chats.splice(idx,1);
        if(state.activeChat >= state.chats.length) state.activeChat = state.chats.length-1;
        renderChats();
        renderMessages();
        saveState();
      };

      const sendMessage = async () => {
        const msg = messageInput.value.trim();
        if(!msg) return;
        addMessage('user', msg);
        messageInput.value = '';
        await sendToAI(msg);
      };

      const sendToAI = async (msg) => {
        if(!state.apiKey) { alert('Set API key in settings'); return; }
        const aiMessage = { role:'assistant', content:'' };
        state.chats[state.activeChat].messages.push(aiMessage);
        renderMessages();
        const div = chatArea.lastChild;

        try {
          const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
            method:'POST',
            headers:{
              'Content-Type':'application/json',
              'Authorization':'Bearer '+state.apiKey
            },
            body: JSON.stringify({
              model: state.model,
              messages: [
                { role:'system', content: state.systemPrompt || '' },
                ...state.chats[state.activeChat].messages.filter(m=>m.role!=='assistant')
              ],
              stream: true
            })
          });

          if(!res.body) throw new Error('No response body');

          const reader = res.body.getReader();
          const decoder = new TextDecoder();
          let done = false;
          while(!done){
            const { value, done: doneReading } = await reader.read();
            done = doneReading;
            const chunk = decoder.decode(value || new Uint8Array());
            aiMessage.content += chunk;
            div.innerHTML = marked.parse(aiMessage.content);
            chatArea.scrollTop = chatArea.scrollHeight;
          }

        } catch(e) {
          console.error(e);
          aiMessage.content = 'âŒ Error: '+e.message;
          div.innerHTML = aiMessage.content;
        }
        saveState();
      };

      // Event Listeners
      sendBtn.addEventListener('click', sendMessage);
      messageInput.addEventListener('keydown', e => { if(e.key==='Enter') sendMessage(); });
      settingsBtn.addEventListener('click', () => settingsModal.classList.remove('hidden'));
      closeSettings.addEventListener('click', () => settingsModal.classList.add('hidden'));
      saveSettings.addEventListener('click', () => {
        state.apiKey = apiKeyInput.value.trim();
        state.model = modelInput.value.trim() || 'deepseek/deepseek-r1:free';
        settingsModal.classList.add('hidden');
        saveState();
      });
      darkModeToggle.addEventListener('click', toggleDarkMode);
      newChatBtn.addEventListener('click', newChat);
      mobileMenuBtn.addEventListener('click', () => {
        sidebar.classList.toggle('-translate-x-64');
      });
      chatListEl.addEventListener('click', e => {
        const idx = e.target.dataset.idx;
        if(idx === undefined) return;
        if(e.target.dataset.action === 'rename') renameChat(Number(idx));
        if(e.target.dataset.action === 'delete') deleteChat(Number(idx));
      });

      // Initial Setup
      loadState();
      document.body.classList.toggle('dark', state.darkMode);
      apiKeyInput.value = state.apiKey;
      modelInput.value = state.model;
      renderChats();
      renderMessages();
      loading.style.display = 'none';
    })();
  </script>
</body>
</html>
